<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.wms.warehousing.mapper.PartsMapper">

    <resultMap type="com.ruoyi.wms.warehousing.domain.Parts" id="PartsResult">
        <result property="id" column="id"/>
        <result property="partsCode" column="parts_code"/>
        <result property="onlyCode" column="only_code"/>
        <result property="produceTime" column="produce_time"/>
        <result property="periodValidity" column="period_validity"/>
        <result property="outStatus" column="out_status"/>
        <result property="delFlag" column="del_flag"/>
        <result property="createBy" column="create_by"/>
        <result property="createTime" column="create_time"/>
        <result property="updateBy" column="update_by"/>
        <result property="updateTime" column="update_time"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <select id="select" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        select
        `id` ,
        `in_bill_code` ,
        `inbill_detail_id` ,
        `only_code` ,
        `parts_code` ,
        `tray_code` ,
        `in_bill_num` ,
        `print_status` ,
        `produce_time` ,
        out_status,
        `period_validity` ,
        `del_flag` ,
        `create_by` ,
        `create_time` ,
        `update_by` ,
        `update_time`,
        `remark`
        from
        wms_inbill_goods
        <where>
            ${ew.sqlSegment}
        </where>
        order by in_bill_code desc,tray_code desc,parts_code desc
    </select>

    <select id="checkCode" resultType="java.lang.Integer">
        select count(*) from wms_inbill_goods
        where parts_code=#{object.partsCode}
         and del_flag = '0'
         and id <![CDATA[ <> ]]>#{object.id}
         and out_status='0'
    </select>

    <select id="checkOnlyCode" resultType="java.lang.Integer">
        select count(*) from wms_inbill_goods
        where only_code=#{ew.onlyCode}
        and del_flag = '0'
        and out_status='0'
    </select>

    <select id="findPartsList" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        SELECT
        g.id,
        b.in_bill_code,
        d.goods_code,
        d.goods_name,
        g.only_code,
        g.parts_code,
        g.produce_time,
        g.out_status,
        g.period_validity,
        g.print_status,
        d.model,
        b.charg,
        (select dict_label from sys_dict_data where dict_type='wms_metering_unit' and dict_value=d.measure_unit) jldw,
        d.supplier_name gys
        FROM
        wms_inbill_goods g
        LEFT JOIN wms_inbill_detail d ON g.inbill_detail_id = d.id
        LEFT JOIN wms_in_bill b ON d.in_bill_code = b.in_bill_code
        <where>
            ${ew.sqlSegment}
        </where>
        order by CONVERT(d.goods_code using ascii) ,CONVERT(g.parts_code using ascii)
    </select>

    <select id="findAddPartsList" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        SELECT
        g.id,
        b.in_bill_code,
        d.goods_code,
        d.goods_name,
        g.only_code,
        g.parts_code,
        g.produce_time,
        g.out_status,
        g.period_validity,
        g.print_status
        FROM
        wms_inbill_goods g
        LEFT JOIN wms_inbill_detail d ON g.inbill_detail_id = d.id
        LEFT JOIN wms_in_bill b ON d.in_bill_code = b.in_bill_code
        WHERE
        d.del_flag = 0
        and b.in_bill_status in(2,3)
        <if test="p.inBillCode!=null and p.inBillCode!=''">
            and g.in_bill_code = #{p.inBillCode}
        </if>
        <if test="p.goodsCode!=null and p.goodsCode!=''">
            and d.goods_code=#{p.goodsCode}
        </if>

        order by d.goods_code, g.only_code ASC
    </select>

    <select id="getCategoryCode" resultType="java.util.Map">
        SELECT
            distinct d.goods_code,
            d.goods_name
        FROM
        wms_inbill_detail d
        LEFT JOIN wms_inbill_goods g ON d.id = g.inbill_detail_id
        WHERE
            d.in_bill_code = #{p.inBillCode}
            AND g.only_code is not null
    </select>

    <select id="findInbillCode" resultType="com.ruoyi.wms.warehousing.domain.InbillDetail">
        SELECT
            distinct b.in_bill_code
        FROM
            wms_inbill_goods g
            LEFT JOIN wms_in_bill b ON g.in_bill_code = b.in_bill_code
        WHERE
            ( g.del_flag = 0 AND b.in_bill_status in (2,3,4) )
        order by b.create_time desc
    </select>

    <select id="findAddInbillCode" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        SELECT
            distinct b.in_bill_code
        FROM
            wms_inbill_goods g
            LEFT JOIN wms_in_bill b ON g.in_bill_code = b.in_bill_code
        WHERE
            ( g.del_flag = 0 AND b.in_bill_status = 2 ) order by b.create_time desc
    </select>

    <update id="updateByOnlyCode" parameterType="com.ruoyi.wms.warehousing.domain.Parts">
        UPDATE wms_inbill_goods
        SET
        <if test="p.partsCode!=null and p.partsCode!=''">
            parts_code = #{p.partsCode}
        </if>
        <if test="p.partsCode!=null and p.partsCode!='' and p.produceTime!=null and p.produceTime!=''">
            ,
        </if>
        <if test="p.produceTime!=null and p.produceTime!=''">
            produce_time = #{p.produceTime}
        </if>
        <if test="p.periodValidity!=null and p.periodValidity!=''">
            ,
        </if>
        <if test="p.periodValidity!=null and p.periodValidity!=''">
            period_validity = #{p.periodValidity}
        </if>
        WHERE only_code = #{p.onlyCode}
    </update>

    <update id="updatePartsPrint" parameterType="com.ruoyi.wms.warehousing.domain.Parts">
        UPDATE wms_inbill_goods SET print_status = 1 WHERE id in
        <foreach collection="ids" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>

    <select id="importPartsList" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        SELECT
        b.in_bill_code,
        d.goods_code,
        d.goods_name,
        d.model,
        g.only_code
        FROM
        wms_inbill_goods g
        LEFT JOIN wms_inbill_detail d ON g.inbill_detail_id = d.id
        LEFT JOIN wms_in_bill b ON d.in_bill_code = b.in_bill_code
        <where>
            ${ew.sqlSegment}
        </where>
        order by d.goods_code ASC,g.only_code asc
    </select>

    <update id="updateByPartsCode" parameterType="com.ruoyi.wms.warehousing.domain.InbillGoods">
        UPDATE wms_inbill_goods
        SET parts_code = #{ew.partsCode},
            produce_time = #{ew.produceDate},
            period_validity = #{ew.periodValidity},
            update_by = #{ew.updateBy},
            update_time = NOW()
        WHERE
            only_code = #{ew.onlyCode}
    </update>

    <select id="listByIds" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        SELECT g.id,
        g.parts_code,
        g.print_status,
        g.only_code,
        d.goods_code,
        d.goods_name,
        d.model,
        b.charg,
        g.produce_time,
        g.period_validity,
        (select dict_label from sys_dict_data where dict_type='wms_metering_unit' and dict_value=d.measure_unit) jldw,
        d.supplier_name gys
        FROM wms_inbill_goods g left join wms_inbill_detail d on g.inbill_detail_id=d.id left join wms_in_bill b on
        g.in_bill_code=b.in_bill_code
        where g.id in
        <foreach collection="ids" item="id" index="index" open="(" close=")" separator=",">
            #{id}
        </foreach>
        order by g.in_bill_code desc,g.tray_code desc,g.parts_code desc
    </select>

    <select id="listByPartCodes" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        SELECT g.id,
        g.parts_code,
        g.print_status,
        g.only_code,
        d.goods_code,
        d.goods_name,
        d.model,
        b.charg,
        g.produce_time,
        g.period_validity,
        (select dict_label from sys_dict_data where dict_type='wms_metering_unit' and dict_value=d.measure_unit) jldw,
        d.supplier_name gys
        FROM wms_inbill_goods g left join wms_inbill_detail d on g.inbill_detail_id=d.id left join wms_in_bill b on
        g.in_bill_code=b.in_bill_code
        where g.parts_code in
        <foreach collection="partCodes" item="item" index="index" open="(" close=")" separator=",">
            #{item}
        </foreach>
        order by g.in_bill_code desc,g.tray_code desc,g.parts_code desc
    </select>

    <select id="selectLists" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        SELECT
        id,parts_code,print_status,only_code
        FROM
        wms_inbill_goods
        <where>
            ${ew.sqlSegment}
        </where>
    </select>

    <select id="findPeriodByCode" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        SELECT goods_code,warranty
        FROM wms_goods_info
        <where>
            ${ew.sqlSegment}
        </where>
    </select>

    <select id="getGoodsCodeByOnly" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        SELECT
            g.warranty
        FROM
            wms_goods_info g
            LEFT JOIN wms_inbill_detail d ON g.goods_code = d.goods_code
            LEFT JOIN wms_inbill_goods w ON d.id = w.inbill_detail_id
        WHERE w.only_code = #{p.onlyCode}
    </select>
    <select id="selectByInbillCode" resultType="com.ruoyi.wms.warehousing.domain.Parts">
        SELECT
        b.in_bill_code,
        d.goods_code,
        d.goods_name,
        g.only_code
        FROM
        wms_inbill_goods g
        LEFT JOIN wms_inbill_detail d ON g.inbill_detail_id = d.id
        LEFT JOIN wms_in_bill b ON d.in_bill_code = b.in_bill_code
        <where>
            <if test="inbillCode!=null and inbillCode !=''">
                and b.in_bill_code=#{inbillCode}
            </if>
        </where>
        order by d.goods_code ASC,g.only_code asc
    </select>

    <select id="checkMultiCode" resultType="java.lang.String">
        select parts_code from wms_inbill_goods
        where 1 = 1
        <if test="list != null">
            and parts_code in
            <foreach collection="list" item="object" open="(" separator="," close=")">
                #{object.partsCode}
            </foreach>
            and id not in
            <foreach collection="list" item="object" open="(" separator="," close=")">
                #{object.id}
            </foreach>
        </if>
        and good_code = #{goodCode}
        and del_flag = '0'
        and out_status='0'
    </select>

    <select id="checkOnlyMultiCode" resultType="java.lang.String">
        select only_code from wms_inbill_goods
        where 1 = 1
        <if test="list != null">
            and only_code in
            <foreach collection="list" item="object" open="(" separator="," close=")">
                #{object.onlyCode}
            </foreach>
        </if>
        and del_flag = '0'
        and out_status='0'
    </select>
</mapper>
